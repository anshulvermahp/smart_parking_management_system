<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Parking Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>

@import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@700&display=swap');
* {
  box-sizing: border-box;
  font-family: 'Google Sans', Arial, sans-serif !important;
  font-weight: 700 !important;
}

body {
  margin: 0;
  background: #f5f5f5;
  color: #111;
  font-family: 'Google Sans', Arial, sans-serif !important;
  font-weight: 700 !important;
}

/* HEADER */
.header {
  height: 64px;
  background: #fff;
  border-bottom: 1px solid #e5e5e5;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 20px;
}
.logo {
  font-weight: 700;
  font-size: 20px;
}

/* LAYOUT */
.layout {
  display: flex;
  height: calc(100vh - 64px - 48px);
}

/* LEFT LIST */
.pakingsInfo {
  width: 380px;
  background: #fff;
  border-right: 1px solid #e5e5e5;
  overflow-y: auto;
  padding: 12px;
}

/* CARD */
.parking-card {
  display: flex;
  gap: 12px;
  padding: 12px;
  border-radius: 10px;
  justify-content: center;
  align-items: center;
  background: #fff;
  margin-bottom: 14px;
  box-shadow: 0 1px 6px rgba(0,0,0,0.08);
}
.parking-card img {
  width: 72px;
  height: 72px;
  object-fit: cover;
  border-radius: 6px;
}
.parking-info h4 {
  margin: 0 0 4px;
  font-size: 15px;
  font-weight: 700;
}
.parking-info p {
  margin: 2px 0;
  font-size: 13px;
  color: #555;
}
.price {
  font-weight: 700;
  margin: 6px 0;
}
.card-actions {
  display: flex;
  gap: 8px;
}
.btn-details {
  background: #fff;
  color: #000;
  border: 1px solid #ddd;
  padding: 6px 10px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}

.btn-details:hover {
  background: #f5f5f5;
}

.btn-reserve {
  background: #000;
  color: #fff;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}

.btn-reserve:hover {
  background: #111;
}


/* MAP */
#map {
  flex: 1;
}

/* POPUP (Parking.com style) */
.leaflet-popup-content {
  margin: 0;
}
.popup-card {
  width: 240px;
}
.popup-card img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 8px 8px 0 0;
}
.popup-body {
  padding: 10px;
}
.popup-body h4 {
  margin: 0 0 4px;
  font-size: 14px;
  font-weight: 700;
}
.popup-body p {
  margin: 2px 0;
  font-size: 12px;
  color: #555;
}
.popup-actions a {
  flex: 1;
  text-align: center;
  text-decoration: none;
  padding: 6px 8px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 6px;
}

/* Directions = secondary */
.popup-details {
  background: #fff;
  color: #000;
  border: 1px solid #ddd;
}

.popup-details:hover {
  background: #f5f5f5;
}

/* Reserve = primary */
.popup-reserve {
  background: #000;
  color: #fff;
}

.popup-reserve:hover {
  background: #111;
}



</style>
</head>

<body>

<div class="header">
  <div class="logo">Parking.com</div>
</div>

<div class="layout">
  <div class="pakingsInfo"></div>
  <div id="map"></div>
</div>

<!-- <div class="footer">
  The Apps · Privacy policy · Terms of service · Contact us
</div> -->

<script>
let map;
let parkingMarkers = {};

function priceMarker(price) {
  return L.divIcon({
    className: '',
    html: `
      <div style="
        background:#fff;
        padding:6px 10px;
        border-radius:18px;
        font-weight:700;
        box-shadow:0 2px 8px rgba(0,0,0,.25);
        border:1px solid #ddd;
      ">
        ₹${price}
      </div>
    `,
    iconSize: [42,28],
    iconAnchor: [21,28]
  });
}

window.onload = function () {
  const areaParam = "<%= area %>";
  const coordMatch = areaParam.match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);

  if (coordMatch) {
    initMap(+coordMatch[1], +coordMatch[2]);
  } else {
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(areaParam)}`)
      .then(r => r.json())
      .then(d => initMap(+d[0].lat, +d[0].lon));
  }
};

function initMap(lat, lon) {
  map = L.map("map").setView([lat, lon], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  loadParking(lat, lon);
}

function loadParking(lat, lon) {
  fetch(`/parking?lat=${lat}&lon=${lon}`)
    .then(r => r.json())
    .then(data => {
      const list = document.querySelector(".pakingsInfo");
      list.innerHTML = "";
      const bounds = [];

      data.forEach((p, i) => {
        const img = p.images?.[0] || "https://via.placeholder.com/240x120";

        /* LEFT CARD */
        list.innerHTML += `
          <div class="parking-card">
            <img src="${img}">
            <div class="parking-info">
              <h4>${p.name}</h4>
              <p>${p.address?.street || ""}</p>
              <div class="price">₹${p.pricing?.hourly || "-"} / hr</div>
              <div class="card-actions">
                <button class="btn-details" onclick="focusParking(${i})">Details</button>
                <button class="btn-reserve" onclick="location.href='/book?parkingId=${p._id}'">Reserve space</button>
              </div>
            </div>
          </div>
        `;

        /* POPUP */
        const popupHTML = `
          <div class="popup-card">
            <img src="${img}">
            <div class="popup-body">
              <h4>${p.name}</h4>
              <p>${p.address?.street || ""}</p>
              <p><strong>₹${p.pricing?.hourly || "-"} / hr</strong></p>
              <div class="popup-actions">
                <a class="popup-details" href="https://www.google.com/maps/dir/?api=1&destination=${p.latitude},${p.longitude}" target="_blank">Directions</a>
                <a class="popup-reserve" href="/book?parkingId=${p._id}">Reserve</a>
              </div>
            </div>
          </div>
        `;

        const marker = L.marker(
  [p.latitude, p.longitude],
  { icon: priceMarker(p.pricing?.hourly || "-") }
).addTo(map)
 .bindPopup(popupHTML, { closeButton: false });

marker.on("mouseover", function () {
  this.openPopup();
});

marker.on("mouseout", function () {
  this.closePopup();
});


        parkingMarkers[i] = marker;
        bounds.push([p.latitude, p.longitude]);
      });

      map.fitBounds(bounds, { padding: [40,40] });
    });
}

function focusParking(i) {
  const m = parkingMarkers[i];
  if (m) {
    map.setView(m.getLatLng(), 17);
    m.openPopup();
  }
}
</script>

</body>
</html>
